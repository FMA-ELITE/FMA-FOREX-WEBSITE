import os
from flask import Flask, request, jsonify
from africastalking.SMS import SMSService
from africastalking.voice import VoiceService
from africastalking.payment import PaymentService

app = Flask(__name__)

# Initialize Africa's Talking (v1.x syntax)
username = os.getenv('AT_USERNAME')
api_key = os.getenv('AT_API_KEY')

sms = SMSService(username, api_key)
voice = VoiceService(username, api_key)
payments = PaymentService(username, api_key)

@app.route('/pay', methods=['POST'])
def handle_payment():
    try:
        data = request.get_json()
        response = payments.mobile_checkout(
            product_name=data['product_name'],
            phone_number=data['phone'],
            currency_code="UGX",
            amount=data['amount'],
            metadata=data.get('metadata', {})
        )
        return jsonify({
            'status': 'success',
            'transaction_id': response['transactionId']
        })
    except Exception as e:
        return jsonify({'status': 'error', 'message': str(e)}), 500

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=10000)